#! /bin/bash
#
# Building RADX and required libraries
# ====================================
#
# Downloading:
# ------------
#
# Download into a single directory all of the files in:
#
#    ftp.rap.ucar.edu/pub/titan/radx
#
# By default the libraries and applications will be installed in:
#
#   /usr/local/include
#   /usr/local/lib
#   /usr/local/bin
#
# You can change the install location by specifying it as
# a single argument to this script.
#
# For example:
#
#   build_radx /tmp/radx_build
#
# will install in:
#
#   /tmp/radx_build/include
#   /tmp/radx_build/lib
#   /tmp/radx_build/bin
#

# Prerequisite - build netcdf
#
# Run the build_netcdf script first, then this one.

#--------------------------------------------------------------------
# usage function
#

function usage() {
    echo
    echo "Usage: build_radx [ -h ] [ prefix ]"
    echo
    echo "  -h: produce this usage list"
    echo "  optionally set the prefix"
    echo
}

# set the path

export PATH=.:/bin:/usr/bin:/sbin:/usr/sbin:/usr/bin/X11:/usr/local/bin:/usr/local/sbin

# set the install prefix

prefix=/usr/local

if [ $# -gt 0 ]
then
  if [ "$1" == -h -o "$2" == -h ] 
  then
    usage
    exit 0
  fi
  prefix=$1
fi

echo "Using prefix: $prefix"

# get operating system, 32-bit or 64-bit, linux or macosx

os_type=x86_64
uname -a | grep x86_64
if [ "$?" = 1 ]
then
    os_type=i686
fi
if [ "$os_type" = "x86_64" ]
then
    uname -a | grep Darwin
    if [ "$?" != 1 ]
    then
        os_type=macosx_x64
    fi
fi

echo "os_type is: $os_type"

# set RPATH to be locatable relative to $ORIGIN, via LDFLAGS

if [ "$os_type" = "macosx_x64" ]
then
  export "LDFLAGS=-L${prefix}/lib"
  #export "LDFLAGS=-L${prefix}/lib -Wl,-rpath,'\$\@loader_path'/radx_runtime_libs:${prefix}/lib"
else
  export "LDFLAGS=-L${prefix}/lib -Wl,-rpath,'\$\$ORIGIN'/radx_runtime_libs:${prefix}/lib"
fi

# Build radx
# ----------

./configure --with-hdf5=${prefix} --with-netcdf=${prefix} --prefix=${prefix} || exit 1
make -j 8 || exit 1
make install-strip || exit 1

# Checking the build
# ------------------

echo
echo
echo
echo "============= Checking libs for RADX - ============="
./distribs/radx/check_libs -p $prefix || exit 1
echo "===================================================="
echo
echo
echo
echo "============= checking apps for RADX ============="
./distribs/radx/check_apps -p $prefix || exit 1
echo "=================================================="
